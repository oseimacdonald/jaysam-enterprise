<%- include('../partials/head', { title: 'Timber Products - Jaysam Enterprise' }) %>

<div class="container-fluid px-0">
    <!-- Image Carousel/Slider Section -->
    <!-- Image Carousel/Slider Section -->
    <section class="hero-carousel mb-5">
        <div id="productCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000">
            <div class="carousel-indicators">
                <!-- Indicators will be dynamically added -->
            </div>
            <div class="carousel-inner">
                <!-- Default placeholder - this will be replaced -->
                <div class="carousel-item active">
                    <div class="carousel-placeholder d-flex align-items-center justify-content-center bg-primary" style="height: 500px;">
                        <div class="text-center text-white">
                            <i class="fas fa-tree fa-5x mb-3"></i>
                            <h3>Quality Timber Products</h3>
                            <p>Loading featured products...</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Manual navigation controls -->
            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </section>

    <div class="container">
        <%- include('../partials/flash-messages') %>

        <!-- Page Header -->
        <div class="page-header text-center mb-5">
            <h1 class="display-4 text-primary">Quality Timber Products</h1>
            <p class="lead">Premium lumber and building materials - All prices in Ghana Cedis (â‚µ)</p>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <p class="text-muted">Select your preferred timber type, choose the size that fits your project, and get instant pricing</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-search me-2"></i>Find Your Perfect Timber</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="/products" class="row g-3" id="filterForm">
                    <div class="col-md-4">
                        <input type="text" name="search" class="form-control" placeholder="Search timber types..." 
                               value="<%= typeof search !== 'undefined' ? search : '' %>"
                               id="searchInput">
                    </div>
                    <div class="col-md-3">
                        <select name="category" class="form-control" id="categorySelect">
                            <option value="">All Categories</option>
                            <option value="Timber" <%= (typeof category !== 'undefined' && category === 'Timber') ? 'selected' : '' %>>Timber</option>
                            <option value="Plywood" <%= (typeof category !== 'undefined' && category === 'Plywood') ? 'selected' : '' %>>Plywood</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select name="grade" class="form-control" id="gradeSelect">
                            <option value="">All Grades</option>
                            <option value="A" <%= (typeof grade !== 'undefined' && grade === 'A') ? 'selected' : '' %>>Grade A</option>
                            <option value="B" <%= (typeof grade !== 'undefined' && grade === 'B') ? 'selected' : '' %>>Grade B</option>
                            <option value="C" <%= (typeof grade !== 'undefined' && grade === 'C') ? 'selected' : '' %>>Grade C</option>
                            <option value="Premium" <%= (typeof grade !== 'undefined' && grade === 'Premium') ? 'selected' : '' %>>Premium</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Timber Products Grid -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Available Timber Types</h5>
                <div class="d-flex gap-2">
                    <button type="button" id="refreshProducts" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <% if (typeof isManager !== 'undefined' && isManager) { %>
                        <a href="/products/add" class="btn btn-success btn-sm">
                            <i class="fas fa-plus me-1"></i>Add Product
                        </a>
                    <% } %>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading products...</span>
                    </div>
                    <p class="mt-2">Loading timber products...</p>
                </div>

                <!-- Products Content -->
                <div id="productsContent" style="display: none;">
                    <% if (typeof timberTypes !== 'undefined' && timberTypes.length > 0) { %>
                        <div class="products-grid">
                            <% timberTypes.forEach(timber => { %>
                                <div class="product-card" data-timber-type="<%= timber.timber_type %>">
                                    <div class="card h-100">
                                        <!-- Product Image -->
                                        <div class="position-relative">
                                            <% if (timber.product_image) { %>
                                                <img src="<%= timber.product_image %>" class="card-img-top product-image" alt="<%= timber.timber_type %>">
                                            <% } else { %>
                                                <div class="card-img-top product-image-placeholder d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-tree fa-3x text-muted"></i>
                                                </div>
                                            <% } %>
                                            <span class="position-absolute top-0 end-0 badge bg-success m-2">
                                                <%= timber.variant_count %> Sizes
                                            </span>
                                        </div>

                                        <div class="card-body d-flex flex-column">
                                            <!-- Timber Type Header -->
                                            <h5 class="product-title card-title">
                                                <%= timber.timber_type %>
                                                <span class="badge bg-secondary float-end">
                                                    <%= timber.product_category %>
                                                </span>
                                            </h5>

                                            <!-- Size Selection -->
                                            <div class="size-selection mb-3">
                                                <label class="form-label small fw-bold mb-1">Select Size:</label>
                                                <select class="form-select form-select-sm size-selector" 
                                                        data-timber-type="<%= timber.timber_type %>">
                                                    <option value="">Choose a size...</option>
                                                    <!-- Size options will be loaded dynamically -->
                                                </select>
                                                <div class="size-details mt-1 small text-muted" 
                                                     id="sizeDetails-<%= timber.timber_type %>" 
                                                     style="display: none;">
                                                    <!-- Size details will be shown here -->
                                                </div>
                                            </div>

                                            <!-- Quantity Selection -->
                                            <div class="quantity-selection mb-3" style="display: none;">
                                                <label class="form-label small fw-bold mb-1">Quantity:</label>
                                                <div class="input-group input-group-sm">
                                                    <button class="btn btn-outline-secondary quantity-minus" type="button">
                                                        <i class="fas fa-minus"></i>
                                                    </button>
                                                    <input type="number" class="form-control quantity-input text-center" 
                                                           value="1" min="1" max="1000" 
                                                           data-timber-type="<%= timber.timber_type %>">
                                                    <button class="btn btn-outline-secondary quantity-plus" type="button">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Dynamic Pricing -->
                                            <div class="pricing-section mb-3" style="display: none;">
                                                <div class="price-breakdown bg-light p-2 rounded">
                                                    <div class="unit-price small mb-1">
                                                        Unit Price: <span class="unit-price-value fw-bold text-primary">â‚µ0.00</span>
                                                    </div>
                                                    <div class="total-price">
                                                        <strong>Total: <span class="total-price-value text-success">â‚µ0.00</span></strong>
                                                    </div>
                                                </div>
                                                <div class="stock-info small text-muted mt-1">
                                                    Stock: <span class="stock-amount">0</span> available
                                                </div>
                                            </div>

                                            <!-- Product Description -->
                                            <div class="product-description mb-3">
                                                <p class="card-text small text-muted description-text" style="min-height: 40px;">
                                                    <!-- Description will be loaded dynamically -->
                                                </p>
                                            </div>

                                            <!-- Action Buttons -->
                                            <div class="product-actions mt-auto">
                                                <div class="btn-group w-100" role="group">
                                                    <button type="button" 
                                                            class="btn btn-outline-primary btn-sm add-to-cart-btn"
                                                            data-timber-type="<%= timber.timber_type %>"
                                                            disabled>
                                                        <i class="fas fa-cart-plus me-1"></i>
                                                        Add to Cart
                                                    </button>
                                                    <button type="button" 
                                                            class="btn btn-outline-info btn-sm view-details-btn"
                                                            data-timber-type="<%= timber.timber_type %>">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>

                        <!-- Pagination -->
                        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
                            <div class="pagination-container">
                                <ul class="pagination justify-content-center">
                                    <!-- Previous Page -->
                                    <% if (currentPage > 1) { %>
                                        <li class="page-item previous">
                                            <a class="page-link" 
                                               href="/products?page=<%= currentPage - 1 %>&search=<%= search || '' %>&category=<%= category || '' %>&grade=<%= grade || '' %>">
                                                Previous
                                            </a>
                                        </li>
                                    <% } %>

                                    <!-- Page Numbers -->
                                    <% for (let i = 1; i <= totalPages; i++) { %>
                                        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                            <a class="page-link" 
                                               href="/products?page=<%= i %>&search=<%= search || '' %>&category=<%= category || '' %>&grade=<%= grade || '' %>">
                                                <%= i %>
                                            </a>
                                        </li>
                                    <% } %>

                                    <!-- Next Page -->
                                    <% if (currentPage < totalPages) { %>
                                        <li class="page-item next">
                                            <a class="page-link" 
                                               href="/products?page=<%= currentPage + 1 %>&search=<%= search || '' %>&category=<%= category || '' %>&grade=<%= grade || '' %>">
                                                Next
                                            </a>
                                        </li>
                                    <% } %>
                                </ul>
                            </div>
                        <% } %>

                    <% } else { %>
                        <div class="empty-products text-center py-5">
                            <div class="empty-icon">ðŸŒ²</div>
                            <h4 class="mt-3">No Timber Products Found</h4>
                            <p class="empty-message text-muted">No timber products match your search criteria.</p>
                            <div class="mt-3">
                                <button type="button" id="clearFilters" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-times me-1"></i>Clear Filters
                                </button>
                                <% if (typeof isManager !== 'undefined' && isManager) { %>
                                    <a href="/products/add" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>Add New Product
                                    </a>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <% if (typeof timberTypes !== 'undefined' && timberTypes.length > 0) { %>
            <div class="products-stats mt-4">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="stat-number display-6 text-primary">
                                <%= typeof totalProducts !== 'undefined' ? totalProducts : timberTypes.length %>
                            </div>
                            <div class="stat-label text-muted">Timber Types</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="stat-number display-6 text-success">
                                <%
                                let totalSizes = 0;
                                if (typeof timberTypes !== 'undefined') {
                                    timberTypes.forEach(t => totalSizes += parseInt(t.variant_count));
                                }
                                %>
                                <%= totalSizes %>
                            </div>
                            <div class="stat-label text-muted">Available Sizes</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="stat-number display-6 text-info">
                                <%
                                let uniqueCategories = [];
                                if (typeof timberTypes !== 'undefined') {
                                    timberTypes.forEach(t => {
                                        if (!uniqueCategories.includes(t.product_category)) {
                                            uniqueCategories.push(t.product_category);
                                        }
                                    });
                                }
                                %>
                                <%= uniqueCategories.length %>
                            </div>
                            <div class="stat-label text-muted">Product Categories</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="stat-number display-6 text-warning">
                                <%
                                let totalStock = 0;
                                if (typeof timberTypes !== 'undefined') {
                                    totalStock = timberTypes.length * 50; // Placeholder
                                }
                                %>
                                <%= totalStock %>
                            </div>
                            <div class="stat-label text-muted">Total in Stock</div>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
</div>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Your custom script -->
<script src="/scripts/productmanagement.js?v=3"></script>